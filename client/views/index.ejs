<%- include('partials/header') %>
<a-scene physics="driver: ammo; debug: true; gravity: -9.8;" background="color: #FAFAFA">
    <!-- CAMERA, CONTROLLERS AND ENVIRONMENT SETTINGS -->
    <%- include('partials/basic_settings') %>

    <!-- BASE PLATE FOR CLOSER UI DESIGN -->
    <%- include('partials/base_plate') %>

    <a-mixin id="sphere-actions"
                hoverable draggable
                grabbable = "constraintComponentName: ammo-constraint;"
                event-set__hoveron="_event: hover-start; opacity: 0.7; transparent: true"
                event-set__hoveroff="_event: hover-end; opacity: 1; transparent: false"
    ></a-mixin>

    <a-mixin id="booth-events"
                transform-if-collided
                geometry="primitive: box; depth: 0.75; height: 0.05; width: 1.25"
                material="color: gray"
                ammo-body="type: static; emitCollisionEvents: true" 
                ammo-shape="type: box"
    ></a-mixin>

    <!-- current node view -->
    <a-sphere object-data="{}"
            ammo-body = "type: dynamic" 
            ammo-shape=" type: box" 
            mixin="sphere-actions" 
            id= "current_node" 
            visible= "false" 
            color="yellow" 
            radius="0.1" 
            position="0 1 -0.75">
        <a-text
            id ="current_node_label"
            position="0 0.3 0"
            width="1"
            color="white"
            value="NO NODE SELECTED"
            side="double"
            align="center"
        ></a-text>        
    </a-sphere>
    
    <!--<a-toast autoshow= 'false' message="" position="0 2 1" action="OK"></a-toast>-->
    <!--<a-cylinder color="gray" height="0.05" radius="0.5" position="0 0.75 1.5" shadow></a-cylinder>-->

    <!-- node search view -->
    <a-keyboard position="-0.75 0.85 -0.8" rotation="-35 0 0" scale="1 1 1" visible='true'></a-keyboard>
    <a-input id='input-1' position="-0.4 1.35 -1.1" placeholder="Search for node" color="black" width="0.6" visible="true"
    onclick="this.focus()">
        <a-button id="go-button" position="0.6 0 0" value="go" width='0.3' scale="0.5 0.5 0.5"></a-button>
    </a-input>
    
    <a-entity id="center_booth" position="0 0.75 -0.9" mixin="booth-events"></a-entity>
    
</a-scene>
<script type="text/javascript">

    window.onload = function(event) {
        var input1= document.querySelector('#input-1');
        var button = document.querySelector('#go-button');
        var str="";
        var keyboard = document.querySelector("a-keyboard");
        var toast = document.querySelector('a-toast');

        toast.addEventListener('actionclick', ()=>{
            toast.hide();

        });

        keyboard.addEventListener('input', (e)=>{
            str += e.detail;
            input1.setAttribute('value', str);
        });

        keyboard.addEventListener('backspace', (e)=>{
            str = str.slice(0, -1);
            input1.setAttribute('value', str);
        });

        button.addEventListener('click', ()=> {
            fetch('/node_search', {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({input: input1.value})
                })
                .then(res=>res.json())
                .then(res =>{
                    //console.log(res.data[0]);
                    document.querySelector('#current_node').setAttribute('visible', res.data[0] ? "true":"false");
                    document.querySelector('#current_node').setAttribute('position', res.data[0] ? "0 1 -1.5":"0 1 -1.5");
                    //document.querySelector('#current_node').components["dynamic-body"].syncToPhysics();

                    document.querySelector('#current_node_label').setAttribute('value', res.data[0] ? `${res.data[0].name}`:"NO NODE FOUND");
                    document.querySelector('#current_node_label').setAttribute('visible', res.data[0] ? "true":"false");
                    //teleport node back to the center_booth
                    document.querySelector('#current_node').setAttribute('object-data', res.data[0] ? "{source: 'https://3quarksdaily.com/3quarksdaily/2013/03/the-inscrutable-brilliance-of-anne-carson.html'}":"{}");
                    keyboard.setAttribute('scale',res.data[0] ? "0 0 0":"1.5 1.5 1.5" );
                    input1.setAttribute('visible',res.data[0] ? "false":"true" );
                    toast.setAttribute('message',res.data[0] ? "Node found!": "Please try another query");
                    toast.show();
                });
        });
    };
    



</script>

<%- include('partials/footer') %>